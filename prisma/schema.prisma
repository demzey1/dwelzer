generator client {
  provider = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "sqlite"
}

// ─── USER & AUTH ────────────────────────────────────────────

model User {
  id             String   @id @default(cuid())
  name           String
  email          String   @unique
  emailVerified  DateTime?
  hashedPassword String?
  image          String?
  phone          String?
  role           String   @default("USER") // USER | ADMIN
  tierId         String   @default("dealing")
  bio            String?
  country        String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tier           Tier     @relation(fields: [tierId], references: [id])
  subscription   Subscription?
  kycVerification KYCVerification?

  // Listings
  realEstateListings RealEstateListing[]
  hotels             Hotel[]
  shortlets          Shortlet[]
  marketplaceItems   MarketplaceItem[]
  legalEntries       LegalEntry[]

  // Transactions
  bookings           Booking[]
  bids               Bid[]
  escrowAsBuyer      EscrowTransaction[] @relation("EscrowBuyer")
  escrowAsSeller     EscrowTransaction[] @relation("EscrowSeller")

  // Messaging
  sentMessages       Message[] @relation("SentMessages")
  receivedMessages   Message[] @relation("ReceivedMessages")

  // Audit
  transactionLogs    TransactionLog[]

  // NextAuth
  accounts           Account[]
  sessions           Session[]

  @@index([email])
  @@index([tierId])
  @@index([role])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ─── TIERS & SUBSCRIPTIONS ──────────────────────────────────

model Tier {
  id          String @id // dealing, realtor, executive, director, lord
  name        String
  price       Float  @default(0)
  maxListings Int    @default(3)
  canCreateListing  Boolean @default(false)
  canUseEscrow      Boolean @default(false)
  canAuction        Boolean @default(false)
  canLegalSearch    Boolean @default(false)
  canAccessAdmin    Boolean @default(false)
  prioritySupport   Boolean @default(false)
  description       String  @default("")

  users         User[]
  subscriptions Subscription[]
}

model Subscription {
  id        String   @id @default(cuid())
  userId    String   @unique
  tierId    String
  status    String   @default("ACTIVE") // ACTIVE | CANCELLED | EXPIRED
  startDate DateTime @default(now())
  endDate   DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  tier Tier @relation(fields: [tierId], references: [id])

  @@index([userId])
  @@index([tierId])
  @@index([status])
}

// ─── REAL ESTATE ────────────────────────────────────────────

model RealEstateListing {
  id          String   @id @default(cuid())
  title       String
  description String
  price       Float
  currency    String   @default("USD")
  type        String   // SALE | RENT
  category    String   // HOUSE | APARTMENT | LAND | COMMERCIAL
  bedrooms    Int      @default(0)
  bathrooms   Int      @default(0)
  area        Float    @default(0)
  address     String
  city        String
  state       String
  country     String
  zipCode     String?
  latitude    Float?
  longitude   Float?
  images      String   @default("[]") // JSON array of image URLs
  features    String   @default("[]") // JSON array of features
  status      String   @default("ACTIVE") // ACTIVE | PENDING | SOLD | RENTED
  featured    Boolean  @default(false)
  verified    Boolean  @default(false)
  views       Int      @default(0)
  userId      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  bookings Booking[]
  messages Message[]
  escrow   EscrowTransaction[]

  @@index([userId])
  @@index([type])
  @@index([category])
  @@index([city])
  @@index([country])
  @@index([status])
  @@index([price])
}

// ─── HOTELS ─────────────────────────────────────────────────

model Hotel {
  id          String   @id @default(cuid())
  name        String
  description String
  pricePerNight Float
  currency    String   @default("USD")
  starRating  Int      @default(3)
  category    String   // LUXURY | BUSINESS | BOUTIQUE | BUDGET | RESORT
  rooms       Int      @default(1)
  amenities   String   @default("[]") // JSON array
  address     String
  city        String
  state       String
  country     String
  latitude    Float?
  longitude   Float?
  images      String   @default("[]")
  checkInTime String   @default("14:00")
  checkOutTime String  @default("11:00")
  status      String   @default("ACTIVE")
  featured    Boolean  @default(false)
  rating      Float    @default(0)
  reviewCount Int      @default(0)
  userId      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  bookings Booking[]

  @@index([userId])
  @@index([city])
  @@index([country])
  @@index([category])
  @@index([pricePerNight])
}

// ─── SHORTLETS ──────────────────────────────────────────────

model Shortlet {
  id          String   @id @default(cuid())
  title       String
  description String
  pricePerNight Float
  currency    String   @default("USD")
  type        String   // APARTMENT | VILLA | STUDIO | PENTHOUSE
  bedrooms    Int      @default(1)
  bathrooms   Int      @default(1)
  maxGuests   Int      @default(2)
  amenities   String   @default("[]")
  rules       String   @default("[]")
  address     String
  city        String
  state       String
  country     String
  latitude    Float?
  longitude   Float?
  images      String   @default("[]")
  status      String   @default("ACTIVE")
  featured    Boolean  @default(false)
  rating      Float    @default(0)
  reviewCount Int      @default(0)
  minNights   Int      @default(1)
  maxNights   Int      @default(30)
  userId      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  bookings Booking[]

  @@index([userId])
  @@index([city])
  @@index([country])
  @@index([type])
  @@index([pricePerNight])
}

// ─── MARKETPLACE ────────────────────────────────────────────

model MarketplaceItem {
  id          String   @id @default(cuid())
  title       String
  description String
  price       Float
  currency    String   @default("USD")
  category    String   // ELECTRONICS | FURNITURE | VEHICLES | FASHION | OTHER
  condition   String   @default("NEW") // NEW | USED | REFURBISHED
  images      String   @default("[]")
  location    String?
  status      String   @default("ACTIVE") // ACTIVE | SOLD | RESERVED
  featured    Boolean  @default(false)
  isAuction   Boolean  @default(false)
  views       Int      @default(0)
  userId      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  auction Auction?

  @@index([userId])
  @@index([category])
  @@index([status])
  @@index([isAuction])
  @@index([price])
}

model Auction {
  id              String   @id @default(cuid())
  itemId          String   @unique
  startingPrice   Float
  currentPrice    Float
  reservePrice    Float?
  startTime       DateTime @default(now())
  endTime         DateTime
  status          String   @default("ACTIVE") // ACTIVE | ENDED | CANCELLED
  winnerUserId    String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  item MarketplaceItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  bids Bid[]

  @@index([itemId])
  @@index([status])
  @@index([endTime])
}

model Bid {
  id        String   @id @default(cuid())
  auctionId String
  userId    String
  amount    Float
  createdAt DateTime @default(now())

  auction Auction @relation(fields: [auctionId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([auctionId])
  @@index([userId])
}

// ─── BOOKINGS ───────────────────────────────────────────────

model Booking {
  id              String   @id @default(cuid())
  userId          String
  bookingType     String   // REAL_ESTATE | HOTEL | SHORTLET
  listingId       String?
  hotelId         String?
  shortletId      String?
  checkIn         DateTime
  checkOut        DateTime
  guests          Int      @default(1)
  totalPrice      Float
  currency        String   @default("USD")
  status          String   @default("PENDING") // PENDING | CONFIRMED | CANCELLED | COMPLETED
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user     User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  listing  RealEstateListing?  @relation(fields: [listingId], references: [id], onDelete: SetNull)
  hotel    Hotel?              @relation(fields: [hotelId], references: [id], onDelete: SetNull)
  shortlet Shortlet?           @relation(fields: [shortletId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([bookingType])
  @@index([status])
  @@index([listingId])
  @@index([hotelId])
  @@index([shortletId])
}

// ─── MESSAGING ──────────────────────────────────────────────

model Message {
  id         String   @id @default(cuid())
  senderId   String
  receiverId String
  listingId  String?
  room       String   // chat room identifier
  content    String
  read       Boolean  @default(false)
  createdAt  DateTime @default(now())

  sender   User               @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User               @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  listing  RealEstateListing?  @relation(fields: [listingId], references: [id], onDelete: SetNull)

  @@index([senderId])
  @@index([receiverId])
  @@index([room])
  @@index([listingId])
  @@index([read])
}

// ─── ESCROW ─────────────────────────────────────────────────

model EscrowTransaction {
  id          String   @id @default(cuid())
  buyerId     String
  sellerId    String
  listingId   String?
  amount      Float
  currency    String   @default("USD")
  status      String   @default("INITIATED") // INITIATED | PENDING | CONFIRMED | DISPUTED | RELEASED | REFUNDED
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  buyer   User               @relation("EscrowBuyer", fields: [buyerId], references: [id], onDelete: Cascade)
  seller  User               @relation("EscrowSeller", fields: [sellerId], references: [id], onDelete: Cascade)
  listing RealEstateListing?  @relation(fields: [listingId], references: [id], onDelete: SetNull)

  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
  @@index([listingId])
}

// ─── LEGAL ──────────────────────────────────────────────────

model LegalEntry {
  id            String   @id @default(cuid())
  title         String
  description   String
  category      String   // PROPERTY_LAW | CONTRACT | DISPUTE | REGULATORY | CORPORATE
  jurisdiction  String
  status        String   @default("OPEN") // OPEN | IN_PROGRESS | RESOLVED | CLOSED
  priority      String   @default("MEDIUM") // LOW | MEDIUM | HIGH | URGENT
  caseNumber    String?
  filingDate    DateTime?
  tags          String   @default("[]")
  documents     String   @default("[]")
  userId        String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([category])
  @@index([jurisdiction])
  @@index([status])
}

// ─── KYC ────────────────────────────────────────────────────

model KYCVerification {
  id             String   @id @default(cuid())
  userId         String   @unique
  documentType   String   // PASSPORT | DRIVERS_LICENSE | NATIONAL_ID
  documentNumber String?
  status         String   @default("PENDING") // PENDING | SUBMITTED | VERIFIED | REJECTED
  veriffSessionId String?
  submittedAt    DateTime?
  verifiedAt     DateTime?
  rejectionReason String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

// ─── AUDIT TRAIL ────────────────────────────────────────────

model TransactionLog {
  id          String   @id @default(cuid())
  userId      String
  action      String   // CREATE | UPDATE | DELETE | BOOKING | ESCROW | BID | LOGIN
  entityType  String   // LISTING | HOTEL | SHORTLET | MARKETPLACE | BOOKING | ESCROW
  entityId    String
  details     String?  // JSON string with extra details
  ipAddress   String?
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([createdAt])
}
